!function(t){var n=t.webkitAudioContext||t.AudioContext;if(!n)throw new Error("No Web Audio API support - cannot initialize Rhombus.");t.Rhombus=function(){var e=new n;Object.defineProperty(this,"_ctx",{value:e});var i=0;this._setId=function(t,n){n>=i&&(i=n+1),Object.defineProperty(t,"id",{value:n,enumerable:!0})},this._newId=function(t){this._setId(t,i),i++},t.Rhombus._graphSetup(this),t.Rhombus._instrumentSetup(this),t.Rhombus._songSetup(this),t.Rhombus._timeSetup(this)}}(this),function(t){t.Util={},t.Util.noteNum2Freq=function(t){var n=440*Math.pow(2,(t-69)/12);return n}}(this.Rhombus),function(t){t._graphSetup=function(t){var n={},e=t._ctx.createGain(),i=t._ctx.createDelay();i.delayTime.value=3/8;var o=t._ctx.createGain();o.gain.value=.2;var s=t._ctx.createGain();s.gain.value=.4,e.connect(t._ctx.destination),i.connect(s),s.connect(i),i.connect(o),o.connect(t._ctx.destination),n.mainout=e,t._graph=n;var r=!1;t.isEffectOn=function(){return r},t.setEffectOn=function(n){n!==r&&(n?(e.disconnect(),e.connect(i)):(e.disconnect(),e.connect(t._ctx.destination)))}}}(this.Rhombus),function(t){t._instrumentSetup=function(n){function e(t){this._pitch=t,this._osc=n._ctx.createOscillator(),this._oscGain=n._ctx.createGain(),this._filter=n._ctx.createBiquadFilter(),this._filterGain=n._ctx.createGain(),this._osc.type="square",this._oscGain.gain.value=0,this._filter.type="lowpass",this._filter.frequency.value=0,this._osc.connect(this._oscGain),this._oscGain.connect(this._filter),this._filter.connect(this._filterGain),this._filterGain.connect(n._graph.mainout),this._filterGain.gain.value=.5}function i(){this._triggers=new Array}e.prototype={noteOn:function(e){var i=n._ctx.currentTime+e,o=t.Util.noteNum2Freq(this._pitch);this._osc.frequency.setValueAtTime(o,n._ctx.currentTime),this._osc.start(i),this._filter.Q.value=3+9*(1-this._pitch/127),this._oscGain.gain.linearRampToValueAtTime(.6,i+.005),this._oscGain.gain.linearRampToValueAtTime(.4,i+.01),this._filter.frequency.linearRampToValueAtTime(4e3,i+.005),this._filter.frequency.exponentialRampToValueAtTime(200,i+.25)},noteOff:function(t,e){if(e&&e!==this._pitch)return!1;var i=n._ctx.currentTime+.125+t;return this._oscGain.gain.linearRampToValueAtTime(0,i),this._osc.stop(i),!0}},i.prototype={noteOn:function(t,n){if(!(0>t||t>127)){var i=new e(t);i.noteOn(n),this._triggers.push(i)}},noteOff:function(t,n){for(var e=[],i=0;i<this._triggers.length;i++)this._triggers[i].noteOff(n,t)||e.push(this._triggers[i]);this._triggers=e},killAllNotes:function(){for(var t=0;t<this._triggers.length;t++)this._triggers[t].noteOff(0);this._triggers=[]}};var o=new i;n.Instrument=o,n.startPreviewNote=function(t){n.Instrument.noteOn(t,0)},n.stopPreviewNote=function(t){n.Instrument.noteOff(t,0)}}}(this.Rhombus),function(t){t._songSetup=function(t){function n(){t._song={},i=t._song,i.notes=new Array,i.notesMap={}}function e(n,e,i){var r=s+o;s+=4*o,t.insertNote(new t.Note(n,r,2*o)),t.insertNote(new t.Note(e,r+o,2*o)),t.insertNote(new t.Note(i,r+2*o,2*o)),t.insertNote(new t.Note(e,r+3*o,2*o))}t.Note=function(n,e,i,o){o?t._setId(this,o):t._newId(this),this._pitch=n||60,this._start=e||0,this._length=i||0},t.Note.prototype={getPitch:function(){return this._pitch},setPitch:function(){},getStart:function(){return this._start},setStart:function(){},getLength:function(){return this._length},setLength:function(){},"delete":function(){}};var i;n(),t.getNoteCount=function(){return i.notes.length},t.getNote=function(t){return i.notes[t]},t.insertNote=function(t){i.notesMap[t.id]=t,i.notes.push(t)},t.importSong=function(e){n();for(var i=JSON.parse(e).notes,o=0;o<i.length;o++)t.insertNote(new t.Note(i[o]._pitch,i[o]._start,i[o]._length,i[o].id))},t.exportSong=function(){return JSON.stringify(i)};var o=240,s=960-o;e(60,63,67),e(60,63,67),e(60,63,68),e(60,63,68),e(60,63,67),e(60,63,67),e(59,62,67),e(59,62,67)}}(this.Rhombus),function(t){t._timeSetup=function(t){function n(){var t="var scheduleId = false;\nself.onmessage = function(oEvent) {\n  if (oEvent.data.playing === false) {\n    if (scheduleId) {\n      clearTimeout(scheduleId);\n    }\n  } else {\n    triggerSchedule();\n  }\n}\nfunction triggerSchedule() {\n  postMessage(0);\n  scheduleId = setTimeout(triggerSchedule, 10);\n}\n",n=new Blob([t],{type:"application/javascript"});return new Worker(URL.createObjectURL(n))}function e(){var n=t._song.notes,e=t.seconds2Ticks(t.getPosition()),i=h,o=e+u,s=e+u,r=e-f;r>=0&&(console.log("Overshot loopOut by "+r+" ticks @ "+t._ctx.currentTime),t.moveToPositionTicks(a+r));for(var c=0,l=0;l<n.length;l++){var _=n[l],g=_.getStart(),p=g+_.getLength();if(g>i&&o>g){var m=t.ticks2Seconds(g)-t.getPosition();t.Instrument.noteOn(_.getPitch(),m),c+=1}if(p>i&&o>p){var m=t.ticks2Seconds(p)-t.getPosition();t.Instrument.noteOff(_.getPitch(),m),c+=1}}h=s}function i(t){return t/l}function o(t){return t*l}function s(){h=0,t.Instrument.killAllNotes()}function r(n){return n?t._ctx.currentTime+p:p}var c=n();c.onmessage=e;var u=100,a=0,f=1920,h=0,l=480,_=120;t.ticks2Seconds=function(t){return i(t)/_*60},t.seconds2Ticks=function(t){var n=t/60*_;return o(n)};var g=!1,p=0;t.startPlayback=function(){g||(g=!0,p-=t._ctx.currentTime,c.postMessage({playing:!0}))},t.stopPlayback=function(){g&&(s(),g=!1,p=r(!0),c.postMessage({playing:!1}))},t.getPosition=function(){return r(g)},t.moveToPositionTicks=function(n){var e=t.ticks2Seconds(n);t.moveToPositionSeconds(e)},t.moveToPositionSeconds=function(n){g?(s(),p=n-t._ctx.currentTime):p=n},t.getLoopEnabled=function(){},t.setLoopEnabled=function(){},t.getLoopStart=function(){},t.setLoopStart=function(){},t.getLoopEnd=function(){},t.setLoopEnd=function(){}}}(this.Rhombus);
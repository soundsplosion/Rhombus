!function(t){var n=t.webkitAudioContext||t.AudioContext;if(!n)throw new Error("No Web Audio API support - cannot initialize Rhombus.");t.Rhombus=function(){var e=new n;Object.defineProperty(this,"_ctx",{value:e});var i=0;this._setId=function(t,n){n>=i&&(i=n+1),Object.defineProperty(t,"id",{value:n,enumerable:!0})},this._newId=function(t){this._setId(t,i)},t.Rhombus._graphSetup(this),t.Rhombus._instrumentSetup(this),t.Rhombus._patternSetup(this),t.Rhombus._songSetup(this),t.Rhombus._timeSetup(this),t.Rhombus._editSetup(this)}}(this),function(t){t.Util={},t.Util.noteNum2Freq=function(t){var n=440*Math.pow(2,(t-69)/12);return n}}(this.Rhombus),function(t){t._graphSetup=function(t){var n={},e=!1;t.getEffectEnabled=function(){return e};var i=t._ctx.createGain(),o=t._ctx.createDelay();o.delayTime.value=3/8;var r=t._ctx.createGain();r.gain.value=.4;var c=t._ctx.createGain();t.getMasterGain=function(){return c.gain.value},t.setMasterGain=function(n){c.gain.linearRampToValueAtTime(n,t._ctx.currentTime+.1)};var s=t._ctx.createGain();s.gain.value=1;var a=t._ctx.createGain(),u=t._ctx.createGain();u.gain.value=.4,t.getWetGain=function(){return u.gain.value},t.setWetGain=function(n){u.gain.linearRampToValueAtTime(n,t._ctx.currentTime+.1)},t.getFeedbackGain=function(){return r.gain.value},t.setFeedbackGain=function(n){r.gain.linearRampToValueAtTime(n,t._ctx.currentTime+.1)},i.connect(s),s.connect(c),i.connect(a),o.connect(r),r.connect(o),a.connect(o),o.connect(u),u.connect(c),c.connect(t._ctx.destination),n.mainout=i,t._graph=n;var f=!1;t.isEffectOn=function(){return f},t.setEffectOn=function(n){n?(e=!0,a.gain.linearRampToValueAtTime(1,t._ctx.currentTime+.1)):(e=!1,a.gain.linearRampToValueAtTime(0,t._ctx.currentTime+.1))},t.setEffectOn(!1)}}(this.Rhombus),function(t){t._instrumentSetup=function(n){function e(t,e){this._pitch=e,this._id=t,this._osc=n._ctx.createOscillator(),this._oscGain=n._ctx.createGain(),this._filter=n._ctx.createBiquadFilter(),this._filterGain=n._ctx.createGain(),this._osc.type="square",this._oscGain.gain.value=0,this._filter.type="lowpass",this._filter.frequency.value=0,this._osc.connect(this._oscGain),this._oscGain.connect(this._filter),this._filter.connect(this._filterGain),this._filterGain.connect(n._graph.mainout),this._filterGain.gain.value=.5}function i(){this._triggers=new Array}var o=.4,r=.2,c=.25,s=24,a=6,u=3,f=.025,h=.25;n.setReleaseTime=function(t){t>=0&&(c=t)},n.getReleaseTime=function(){return c},n.setFilterCutoff=function(t){t>=0&&127>=t&&(s=t)},n.getFilterCutoff=function(){return s},n.setFilterRes=function(t){t>=0&&24>=t&&(a=t)},n.getFilterRes=function(){return a},n.setEnvDepth=function(t){t>=0&&19>=t&&(u=t+1)},n.getEnvDepth=function(){return u},n.setAttackTime=function(t){t>=0&&(f=t)},n.getAttackTime=function(){return f},n.setDecayTime=function(t){t>=0&&(h=t)},n.getDecayTime=function(){return h},e.prototype={noteOn:function(e){var i=n._ctx.currentTime+e,c=t.Util.noteNum2Freq(+this._pitch),_=t.Util.noteNum2Freq(+this._pitch+s);this._osc.frequency.setValueAtTime(c,n._ctx.currentTime),this._osc.start(i),this._filter.Q.value=(1-this._pitch/127)*a,this._oscGain.gain.setValueAtTime(0,i),this._oscGain.gain.linearRampToValueAtTime(o,i+.005),this._oscGain.gain.linearRampToValueAtTime(r,i+.05),this._filter.frequency.setValueAtTime(_,i),this._filter.frequency.exponentialRampToValueAtTime(_*u,i+f+.005),this._filter.frequency.exponentialRampToValueAtTime(_,i+h+f)},noteOff:function(t,e){if(e&&e!==this._id)return!1;var i=n._ctx.currentTime+t;return this._oscGain.gain.cancelScheduledValues(i),this._oscGain.gain.setValueAtTime(r,i),this._oscGain.gain.linearRampToValueAtTime(0,i+c),this._osc.stop(i+c+.125),!0}},i.prototype={noteOn:function(t,n,i){if(!(0>n||n>127)){var o=new e(t,n);o.noteOn(i),this._triggers.push(o)}},noteOff:function(t,n){for(var e=[],i=0;i<this._triggers.length;i++)this._triggers[i].noteOff(n,t)||e.push(this._triggers[i]);this._triggers=e},killAllNotes:function(){for(var t=0;t<this._triggers.length;t++)this._triggers[t].noteOff(0);this._triggers=[]}};var _=new i;n.Instrument=_;var g=void 0;n.startPreviewNote=function(t){void 0===g&&(g=new Note(t,0),n.Instrument.noteOn(g.id,t,0))},n.stopPreviewNote=function(){void 0!==g&&(n.Instrument.noteOff(g.id,0),g=void 0)}}}(this.Rhombus),function(t){t._patternSetup=function(t){var n=0;t.Pattern=function(){this._noteMap={},this._id=n,n+=1},t.Note=function(n,e,i,o){o?t._setId(this,o):t._newId(this),this._pitch=n||60,this._start=e||0,this._length=i||0},t.Note.prototype={getPitch:function(){return this._pitch},getStart:function(){return this._start},getLength:function(){return this._length},getEnd:function(){return this._start+this._length}}}}(this.Rhombus),function(t){t._songSetup=function(t){function n(){this._length=3840,this._patterns={}}n.prototype={addPattern:function(){var n=new t.Pattern;this._patterns[n._id]=n}};var e=new n;t.Song=e,t.Song.addPattern(),t.getSongLengthSeconds=function(){return t.ticks2Seconds(t.Song._length)},t.importSong=function(n){newSong();for(var e=JSON.parse(n).notes,i=0;i<e.length;i++)t.Edit.insertNote(new t.Note(e[i]._pitch,e[i]._start,e[i]._length,e[i].id),0)},t.exportSong=function(){return JSON.stringify(t.Song)}}}(this.Rhombus),function(t){t._timeSetup=function(t){function n(){var t="var scheduleId = false;\nself.onmessage = function(oEvent) {\n  if (oEvent.data.playing === false) {\n    if (scheduleId) {\n      clearTimeout(scheduleId);\n    }\n  } else {\n    triggerSchedule();\n  }\n}\nfunction triggerSchedule() {\n  postMessage(0);\n  scheduleId = setTimeout(triggerSchedule, 10);\n}\n",n=new Blob([t],{type:"application/javascript"});return new Worker(URL.createObjectURL(n))}function e(){var n=t.Song._patterns[0]._noteMap,e=t.seconds2Ticks(t.getPosition()),i=t.seconds2Ticks(a),o=t.getLoopEnabled()&&t.getLoopEnd()-e<i,r=u,c=o?t.getLoopEnd():e+i;for(var s in n){var f=n[s],h=f.getStart(),_=f.getEnd();if(h>=r&&c>h){var g=t.ticks2Seconds(h)-t.getPosition();t.Instrument.noteOn(f.id,f.getPitch(),g)}if(_>=r&&c>_){var g=t.ticks2Seconds(_)-t.getPosition();t.Instrument.noteOff(f.id,g)}}u=c,o&&t.loopPlayback(e)}function i(t){return t/f}function o(t){return t*f}function r(){u=-1,t.Instrument.killAllNotes()}function c(n){return n?t._ctx.currentTime+g:g}var s=n();s.onmessage=e;var a=.03,u=-1,f=480,h=120;t.ticks2Seconds=function(t){return i(t)/h*60},t.seconds2Ticks=function(t){var n=t/60*h;return o(n)};var _=!1,g=0,l=0,p=3840,d=!1;t.startPlayback=function(){_||(_=!0,g-=t._ctx.currentTime,s.postMessage({playing:!0}))},t.stopPlayback=function(){_&&(r(),_=!1,g=c(!0),s.postMessage({playing:!1}))},t.loopPlayback=function(n){var i=n-p;i>=0&&d===!0&&(t.moveToPositionTicks(l+i),u=l-i,e(i))},t.getPosition=function(){return c(_)},t.moveToPositionTicks=function(n){var e=t.ticks2Seconds(n);t.moveToPositionSeconds(e)},t.moveToPositionSeconds=function(n){_?(r(),g=n-t._ctx.currentTime):g=n},t.getLoopEnabled=function(){return d},t.setLoopEnabled=function(t){d=t},t.getLoopStart=function(){return l},t.setLoopStart=function(t){l=t},t.getLoopEnd=function(){return p},t.setLoopEnd=function(t){p=t},t.isPlaying=function(){return _}}}(this.Rhombus),function(t){t._editSetup=function(t){function n(n){var e=t.seconds2Ticks(t.getPosition()),i=n.getStart()<=e&&e<=n.getEnd();i&&t.Instrument.noteOff(n.id,0)}t.Edit={},t.Edit.insertNote=function(n,e){t.Song._patterns[e]._noteMap[n.id]=n},t.Edit.changeNoteTime=function(e,i,o,r){var c=t.Song._patterns[r]._noteMap[e],s=curTicks>=i&&i+o>=curTicks;s||n(c),c._start=i,c._length=o},t.Edit.changeNotePitch=function(n,e,i){var o=t.Song._patterns[i]._noteMap[n];e!==o.getPitch()&&(t.Instrument.noteOff(o.id,0),o._pitch=e)},t.Edit.deleteNote=function(e,i){var o=t.Song._patterns[i]._noteMap[e];void 0!==o&&(delete t.Song._patterns[i]._noteMap[o.id],n(o))}}}(this.Rhombus);
!function(t){var n=t.webkitAudioContext||t.AudioContext;if(!n)throw new Error("No Web Audio API support - cannot initialize Rhombus.");t.Rhombus=function(){var e=new n;Object.defineProperty(this,"_ctx",{value:e});var o=0;this._setId=function(t,n){n>=o&&(o=n+1),Object.defineProperty(t,"id",{value:n,enumerable:!0})},this._newId=function(t){this._setId(t,o)},t.Rhombus._graphSetup(this),t.Rhombus._instrumentSetup(this),t.Rhombus._songSetup(this),t.Rhombus._timeSetup(this),t.Rhombus._editSetup(this)}}(this),function(t){function n(t){return 440*Math.pow(2,(t-69)/12)}t.Util={};for(var e=[],o=0;127>o;o++)e[o]=n(o);t.Util.noteNum2Freq=function(t){return e[t]}}(this.Rhombus),function(t){t._graphSetup=function(t){var n={},e=!1;t.getEffectEnabled=function(){return e};var o=t._ctx.createGain(),i=t._ctx.createDelay();i.delayTime.value=3/8;var r=t._ctx.createGain();r.gain.value=.4;var c=t._ctx.createGain();t.getMasterGain=function(){return c.gain.value},t.setMasterGain=function(n){c.gain.linearRampToValueAtTime(n,t._ctx.currentTime+.1)};var s=t._ctx.createGain();s.gain.value=1;var u=t._ctx.createGain(),a=t._ctx.createGain();a.gain.value=.4,t.getWetGain=function(){return a.gain.value},t.setWetGain=function(n){a.gain.linearRampToValueAtTime(n,t._ctx.currentTime+.1)},t.getFeedbackGain=function(){return r.gain.value},t.setFeedbackGain=function(n){r.gain.linearRampToValueAtTime(n,t._ctx.currentTime+.1)},o.connect(s),s.connect(c),o.connect(u),i.connect(r),r.connect(i),u.connect(i),i.connect(a),a.connect(c),c.connect(t._ctx.destination),n.mainout=o,t._graph=n;var f=!1;t.isEffectOn=function(){return f},t.setEffectOn=function(n){n?(e=!0,u.gain.linearRampToValueAtTime(1,t._ctx.currentTime+.1)):(e=!1,u.gain.linearRampToValueAtTime(0,t._ctx.currentTime+.1))},t.setEffectOn(!1)}}(this.Rhombus),function(t){t._instrumentSetup=function(n){function e(){this._toneSynth=new Tone.MonoSynth,this._toneSynth.toMaster()}e.prototype={noteOn:function(n,e,o){if(!(0>e||e>127)){var i=t.Util.noteNum2Freq(e);o>0?this._toneSynth.triggerAttack(i,"+"+o):this._toneSynth.triggerAttack(i)}},noteOff:function(t,n){n>0?this._toneSynth.triggerRelease("+"+n):this._toneSynth.triggerRelease()},killAllNotes:function(){this._toneSynth.triggerRelease()}};var o=new e;n.Instrument=o;var i=void 0;n.startPreviewNote=function(t){void 0===i&&(i=new n.Note(t,0),n.Instrument.noteOn(i.id,t,0))},n.stopPreviewNote=function(){void 0!==i&&(n.Instrument.noteOff(i.id,0),i=void 0)}}}(this.Rhombus),function(t){t._songSetup=function(t){function n(){t._song={},e=t._song,e.notes=new Array,e.notesMap={}}t.Note=function(n,e,o,i){i?t._setId(this,i):t._newId(this),this._pitch=n||60,this._start=e||0,this._length=o||0},t.Note.prototype={getPitch:function(){return this._pitch},getStart:function(){return this._start},getLength:function(){return this._length},getEnd:function(){return this._start+this._length}};var e;n(),t.getNoteCount=function(){return e.notes.length},t.getNote=function(t){return e.notes[t]},t.getSongLengthSeconds=function(){var n=e.notes[t.getNoteCount()-1];return t.ticks2Seconds(n.getStart()+n.getLength())},t.importSong=function(e){n();for(var o=JSON.parse(e).notes,i=0;i<o.length;i++)t.Edit.insertNote(new t.Note(o[i]._pitch,o[i]._start,o[i]._length,o[i].id))},t.exportSong=function(){return JSON.stringify(e)}}}(this.Rhombus),function(t){t._timeSetup=function(t){function n(){var t="var scheduleId = false;\nself.onmessage = function(oEvent) {\n  if (oEvent.data.playing === false) {\n    if (scheduleId) {\n      clearTimeout(scheduleId);\n    }\n  } else {\n    triggerSchedule();\n  }\n}\nfunction triggerSchedule() {\n  postMessage(0);\n  scheduleId = setTimeout(triggerSchedule, 10);\n}\n",n=new Blob([t],{type:"application/javascript"});return new Worker(URL.createObjectURL(n))}function e(){for(var n=t._song.notes,e=t.seconds2Ticks(t.getPosition()),o=t.seconds2Ticks(u),i=t.getLoopEnabled()&&t.getLoopEnd()-e<o,r=a,c=i?t.getLoopEnd():e+o,s=0;s<n.length;s++){var f=n[s],g=f.getStart(),h=f.getEnd();if(g>=r&&c>g){var l=t.ticks2Seconds(g)-t.getPosition();t.Instrument.noteOn(f.id,f.getPitch(),l)}if(h>=r&&c>h){var l=t.ticks2Seconds(h)-t.getPosition();t.Instrument.noteOff(f.id,l)}}a=c,i&&t.loopPlayback(e)}function o(t){return t/f}function i(t){return t*f}function r(){a=-1,t.Instrument.killAllNotes()}function c(n){return n?t._ctx.currentTime+l:l}var s=n();s.onmessage=e;var u=.03,a=-1,f=480,g=120;t.ticks2Seconds=function(t){return o(t)/g*60},t.seconds2Ticks=function(t){var n=t/60*g;return i(n)};var h=!1,l=0,d=0,p=3840,_=!1;t.startPlayback=function(){h||(h=!0,l-=t._ctx.currentTime,s.postMessage({playing:!0}))},t.stopPlayback=function(){h&&(r(),h=!1,l=c(!0),s.postMessage({playing:!1}))},t.loopPlayback=function(n){var o=n-p;o>=0&&_===!0&&(t.moveToPositionTicks(d+o),a=d-o,e(o))},t.getPosition=function(){return c(h)},t.moveToPositionTicks=function(n){var e=t.ticks2Seconds(n);t.moveToPositionSeconds(e)},t.moveToPositionSeconds=function(n){h?(r(),l=n-t._ctx.currentTime):l=n},t.getLoopEnabled=function(){return _},t.setLoopEnabled=function(t){_=t},t.getLoopStart=function(){return d},t.setLoopStart=function(t){d=t},t.getLoopEnd=function(){return p},t.setLoopEnd=function(t){p=t},t.isPlaying=function(){return h}}}(this.Rhombus),function(t){t._editSetup=function(t){function n(n){var e=t.seconds2Ticks(t.getPosition()),o=n.getStart()<=e&&e<=n.getEnd();o&&t.Instrument.noteOff(n.id,0)}t.Edit={},t.Edit.insertNote=function(n){t._song.notesMap[n.id]=n,t._song.notes.push(n)},t.Edit.changeNoteTime=function(e,o,i){var r=t._song.notesMap[e],c=curTicks>=o&&o+i>=curTicks;c||n(r),r._start=o,r._length=i},t.Edit.changeNotePitch=function(n,e){var o=t._song.notesMap[n];e!==o.getPitch()&&(t.Instrument.noteOff(o.id,0),o._pitch=e)},t.Edit.deleteNote=function(e){var o=t._song.notesMap[e];delete t._song.notesMap[o.id];for(var i=t._song.notes,r=0;r<i.length;r++)if(i[r].id===o.id)return i.splice(r,1),void n(o)}}}(this.Rhombus);
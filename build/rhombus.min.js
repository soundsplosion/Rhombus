!function(t){var e=[];t.Rhombus=function(){e.push(this),this._active=!0,this._disposed=!1,this._ctx=Tone.context,this.setActive=function(t){this._disposed||(this._active=t)},this.dispose=function(){this.setActive(!1),this._disposed=!0,delete this._ctx;for(var t=0;t<e.length;t++)if(e[t]===this)return void e.splice(t,1)};var n=0;this._setId=function(t,e){e>=n&&(n=e+1),Object.defineProperty(t,"id",{value:e,enumerable:!0})},this._newId=function(t){this._setId(t,n)},t.Rhombus._graphSetup(this),t.Rhombus._instrumentSetup(this),t.Rhombus._songSetup(this),t.Rhombus._timeSetup(this),t.Rhombus._editSetup(this)}}(this),function(t){function e(t){return 440*Math.pow(2,(t-69)/12)}t.Util={};for(var n=[],i=0;127>i;i++)n[i]=e(i);t.Util.noteNum2Freq=function(t){return n[t]}}(this.Rhombus),function(t){t._graphSetup=function(t){var e={},n=!1;t.getEffectEnabled=function(){return n};var i=t._ctx.createGain(),o=t._ctx.createDelay();o.delayTime.value=3/8;var r=t._ctx.createGain();r.gain.value=.4;var s=t._ctx.createGain();t.getMasterGain=function(){return s.gain.value},t.setMasterGain=function(e){s.gain.linearRampToValueAtTime(e,t._ctx.currentTime+.1)};var c=t._ctx.createGain();c.gain.value=1;var a=t._ctx.createGain(),u=t._ctx.createGain();u.gain.value=.4,t.getWetGain=function(){return u.gain.value},t.setWetGain=function(e){u.gain.linearRampToValueAtTime(e,t._ctx.currentTime+.1)},t.getFeedbackGain=function(){return r.gain.value},t.setFeedbackGain=function(e){r.gain.linearRampToValueAtTime(e,t._ctx.currentTime+.1)},i.connect(c),c.connect(s),i.connect(a),o.connect(r),r.connect(o),a.connect(o),o.connect(u),u.connect(s),s.connect(t._ctx.destination),e.mainout=i,t._graph=e;var g=!1;t.isEffectOn=function(){return g},t.setEffectOn=function(e){e?(n=!0,a.gain.linearRampToValueAtTime(1,t._ctx.currentTime+.1)):(n=!1,a.gain.linearRampToValueAtTime(0,t._ctx.currentTime+.1))},t.setEffectOn(!1)}}(this.Rhombus),function(t){t._instrumentSetup=function(e){function n(){Tone.PolySynth.call(this,6,Tone.MonoSynth),this.toMaster(),this._triggered={}}Tone.extend(n,Tone.PolySynth),n.prototype.triggerAttack=function(e,n,i){if(!(0>n||n>127)){var o=Tone.PolySynth.prototype.triggerAttack,r=t.Util.noteNum2Freq(n);this._triggered[e]=r,i>0?o.call(this,r,"+"+i):o.call(this,r)}},n.prototype.triggerRelease=function(t,e){var n=Tone.PolySynth.prototype.triggerRelease,i=this._triggered[t];e>0?n.call(this,i,"+"+e):n.call(this,i)},n.prototype.killAllNotes=function(){var t=[];for(var e in this._triggered)t.push(this._triggered[e]);Tone.PolySynth.prototype.triggerRelease.call(this,t),this._triggered={}};var i=new n;e.Instrument=i;var o=void 0;e.startPreviewNote=function(t){void 0===o&&(o=new e.Note(t,0),e.Instrument.triggerAttack(o.id,t,0))},e.stopPreviewNote=function(){void 0!==o&&(e.Instrument.triggerRelease(o.id,0),o=void 0)}}}(this.Rhombus),function(t){t._songSetup=function(t){function e(){t._song={},n=t._song,n.notes=new Array,n.notesMap={}}t.Note=function(e,n,i,o){o?t._setId(this,o):t._newId(this),this._pitch=e||60,this._start=n||0,this._length=i||0},t.Note.prototype={getPitch:function(){return this._pitch},getStart:function(){return this._start},getLength:function(){return this._length},getEnd:function(){return this._start+this._length}};var n;e(),t.getNoteCount=function(){return n.notes.length},t.getNote=function(t){return n.notes[t]},t.getSongLengthSeconds=function(){var e=n.notes[t.getNoteCount()-1];return t.ticks2Seconds(e.getStart()+e.getLength())},t.importSong=function(n){e();for(var i=JSON.parse(n).notes,o=0;o<i.length;o++)t.Edit.insertNote(new t.Note(i[o]._pitch,i[o]._start,i[o]._length,i[o].id))},t.exportSong=function(){return JSON.stringify(n)}}}(this.Rhombus),function(t){t._timeSetup=function(t){function e(){var t="var scheduleId = false;\nself.onmessage = function(oEvent) {\n  if (oEvent.data.playing === false) {\n    if (scheduleId) {\n      clearTimeout(scheduleId);\n    }\n  } else {\n    triggerSchedule();\n  }\n}\nfunction triggerSchedule() {\n  postMessage(0);\n  scheduleId = setTimeout(triggerSchedule, 10);\n}\n",e=new Blob([t],{type:"application/javascript"});return new Worker(URL.createObjectURL(e))}function n(){for(var e=t._song.notes,n=t.seconds2Ticks(t.getPosition()),i=t.seconds2Ticks(a),o=t.getLoopEnabled()&&t.getLoopEnd()-n<i,r=u,s=o?t.getLoopEnd():n+i,c=0;c<e.length;c++){var g=e[c],h=g.getStart(),f=g.getEnd();if(h>=r&&s>h){var l=t.ticks2Seconds(h)-t.getPosition();t.Instrument.triggerAttack(g.id,g.getPitch(),l)}if(f>=r&&s>f){var l=t.ticks2Seconds(f)-t.getPosition();t.Instrument.triggerRelease(g.id,l)}}u=s,o&&t.loopPlayback(n)}function i(t){return t/g}function o(t){return t*g}function r(){u=-1,t.Instrument.killAllNotes()}function s(e){return e?t._ctx.currentTime+l:l}var c=e();c.onmessage=n;var a=.03,u=-1,g=480,h=120;t.ticks2Seconds=function(t){return i(t)/h*60},t.seconds2Ticks=function(t){var e=t/60*h;return o(e)};var f=!1,l=0,d=0,p=3840,_=!1;t.startPlayback=function(){t._active&&!f&&(f=!0,l-=t._ctx.currentTime,c.postMessage({playing:!0}))},t.stopPlayback=function(){t._active&&f&&(r(),f=!1,l=s(!0),c.postMessage({playing:!1}))},t.loopPlayback=function(e){var i=e-p;i>=0&&_===!0&&(t.moveToPositionTicks(d+i),u=d-i,n(i))},t.getPosition=function(){return s(f)},t.moveToPositionTicks=function(e){var n=t.ticks2Seconds(e);t.moveToPositionSeconds(n)},t.moveToPositionSeconds=function(e){f?(r(),l=e-t._ctx.currentTime):l=e},t.getLoopEnabled=function(){return _},t.setLoopEnabled=function(t){_=t},t.getLoopStart=function(){return d},t.setLoopStart=function(t){d=t},t.getLoopEnd=function(){return p},t.setLoopEnd=function(t){p=t},t.isPlaying=function(){return f}}}(this.Rhombus),function(t){t._editSetup=function(t){function e(e){var n=t.seconds2Ticks(t.getPosition()),i=e.getStart()<=n&&n<=e.getEnd();i&&t.Instrument.triggerRelease(e.id,0)}t.Edit={},t.Edit.insertNote=function(e){t._song.notesMap[e.id]=e,t._song.notes.push(e)},t.Edit.changeNoteTime=function(n,i,o){var r=t._song.notesMap[n],s=curTicks>=i&&i+o>=curTicks;s||e(r),r._start=i,r._length=o},t.Edit.changeNotePitch=function(e,n){var i=t._song.notesMap[e];n!==i.getPitch()&&(t.Instrument.triggerRelease(i.id,0),i._pitch=n)},t.Edit.deleteNote=function(n){var i=t._song.notesMap[n];delete t._song.notesMap[i.id];for(var o=t._song.notes,r=0;r<o.length;r++)if(o[r].id===i.id)return o.splice(r,1),void e(i)}}}(this.Rhombus);
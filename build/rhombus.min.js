!function(t){var e=t.webkitAudioContext||t.AudioContext;if(!e)throw new Error("No Web Audio API support - cannot initialize Rhombus.");t.Rhombus=function(){var n=new e;Object.defineProperty(this,"_ctx",{value:n});var i=0;this._setId=function(t,e){e>=i&&(i=e+1),Object.defineProperty(t,"id",{value:e,enumerable:!0})},this._newId=function(t){this._setId(t,i),i++},t.Rhombus._graphSetup(this),t.Rhombus._instrumentSetup(this),t.Rhombus._songSetup(this),t.Rhombus._timeSetup(this)}}(this),function(t){t.Util={},t.Util.noteNum2Freq=function(t){var e=440*Math.pow(2,(t-69)/12);return e}}(this.Rhombus),function(t){t._graphSetup=function(t){var e={},n=!1;t.getEffectEnabled=function(){return n};var i=t._ctx.createGain(),o=t._ctx.createDelay();o.delayTime.value=3/8;var r=t._ctx.createGain();r.gain.value=.4;var s=t._ctx.createGain();t.getMasterGain=function(){return s.gain.value},t.setMasterGain=function(t){s.gain.value=t};var c=t._ctx.createGain();c.gain.value=1;var a=t._ctx.createGain(),u=t._ctx.createGain();u.gain.value=0;var f=.5;t.getWetLevel=function(){return f},t.setWetLevel=function(t){f=t,n&&(u.gain.value=t)};var h=.5;t.getFeedbackLevel=function(){return h},t.setFeedbackLevel=function(t){h=t,r.gain.value=t},i.connect(c),c.connect(s),i.connect(a),o.connect(r),r.connect(o),a.connect(o),o.connect(u),u.connect(s),s.connect(t._ctx.destination),e.mainout=i,t._graph=e;var g=!1;t.isEffectOn=function(){return g},t.setEffectOn=function(t){t?(n=!0,a.gain.value=1):(n=!1,a.gain.value=0)},t.setEffectOn(!1)}}(this.Rhombus),function(t){t._instrumentSetup=function(e){function n(t){this._pitch=t,this._osc=e._ctx.createOscillator(),this._oscGain=e._ctx.createGain(),this._filter=e._ctx.createBiquadFilter(),this._filterGain=e._ctx.createGain(),this._osc.type="square",this._oscGain.gain.value=0,this._filter.type="lowpass",this._filter.frequency.value=0,this._osc.connect(this._oscGain),this._oscGain.connect(this._filter),this._filter.connect(this._filterGain),this._filterGain.connect(e._graph.mainout),this._filterGain.gain.value=.5}function i(){this._triggers=new Array}n.prototype={noteOn:function(n){var i=e._ctx.currentTime+n,o=t.Util.noteNum2Freq(this._pitch);this._osc.frequency.setValueAtTime(o,e._ctx.currentTime),this._osc.start(i),this._filter.Q.value=3+9*(1-this._pitch/127),this._oscGain.gain.linearRampToValueAtTime(.6,i+.005),this._oscGain.gain.linearRampToValueAtTime(.4,i+.01),this._filter.frequency.linearRampToValueAtTime(4e3,i+.005),this._filter.frequency.exponentialRampToValueAtTime(200,i+.25)},noteOff:function(t,n){if(n&&n!==this._pitch)return!1;var i=e._ctx.currentTime+.125+t;return this._oscGain.gain.linearRampToValueAtTime(0,i),this._osc.stop(i),!0}},i.prototype={noteOn:function(t,e){if(!(0>t||t>127)){var i=new n(t);i.noteOn(e),this._triggers.push(i)}},noteOff:function(t,e){for(var n=[],i=0;i<this._triggers.length;i++)this._triggers[i].noteOff(e,t)||n.push(this._triggers[i]);this._triggers=n},killAllNotes:function(){for(var t=0;t<this._triggers.length;t++)this._triggers[t].noteOff(0);this._triggers=[]}};var o=new i;e.Instrument=o,e.startPreviewNote=function(t){e.Instrument.noteOn(t,0)},e.stopPreviewNote=function(t){e.Instrument.noteOff(t,0)}}}(this.Rhombus),function(t){t._songSetup=function(t){function e(){t._song={},i=t._song,i.notes=new Array,i.notesMap={}}function n(e,n,i){var s=r+o;r+=4*o,t.insertNote(new t.Note(e,s,2*o)),t.insertNote(new t.Note(n,s+o,2*o)),t.insertNote(new t.Note(i,s+2*o,2*o)),t.insertNote(new t.Note(n,s+3*o,2*o))}t.Note=function(e,n,i,o){o?t._setId(this,o):t._newId(this),this._pitch=e||60,this._start=n||0,this._length=i||0},t.Note.prototype={getPitch:function(){return this._pitch},setPitch:function(){},getStart:function(){return this._start},setStart:function(){},getLength:function(){return this._length},setLength:function(){},"delete":function(){}};var i;e(),t.getNoteCount=function(){return i.notes.length},t.getNote=function(t){return i.notes[t]},t.insertNote=function(t){i.notesMap[t.id]=t,i.notes.push(t)},t.getSongLengthSeconds=function(){var e=i.notes[t.getNoteCount()-1];return t.ticks2Seconds(e.getStart()+e.getLength())},t.importSong=function(n){e();for(var i=JSON.parse(n).notes,o=0;o<i.length;o++)t.insertNote(new t.Note(i[o]._pitch,i[o]._start,i[o]._length,i[o].id))},t.exportSong=function(){return JSON.stringify(i)};var o=240,r=960-o;n(60,63,67),n(60,63,67),n(60,63,68),n(60,63,68),n(60,63,67),n(60,63,67),n(59,62,67),n(59,62,67)}}(this.Rhombus),function(t){t._timeSetup=function(t){function e(){var t="var scheduleId = false;\nself.onmessage = function(oEvent) {\n  if (oEvent.data.playing === false) {\n    if (scheduleId) {\n      clearTimeout(scheduleId);\n    }\n  } else {\n    triggerSchedule();\n  }\n}\nfunction triggerSchedule() {\n  postMessage(0);\n  scheduleId = setTimeout(triggerSchedule, 10);\n}\n",e=new Blob([t],{type:"application/javascript"});return new Worker(URL.createObjectURL(e))}function n(){for(var e=t._song.notes,n=t.seconds2Ticks(t.getPosition()),i=t.getLoopEnabled&&t.getLoopEnd()-n<a,o=i?t.getLoopEnd():u,r=i?t.getLoopEnd():n+a,s=i?t.getLoopEnd():n+a,c=0,f=0;f<e.length;f++){var h=e[f],g=h.getStart(),l=g+h.getLength();if(g>o&&r>g){var _=t.ticks2Seconds(g)-t.getPosition();t.Instrument.noteOn(h.getPitch(),_),c+=1}if(l>o){var _=t.ticks2Seconds(l)-t.getPosition();t.Instrument.noteOff(h.getPitch(),_),c+=1}}u=s,i&&t.loopPlayback(n)}function i(t){return t/f}function o(t){return t*f}function r(){u=0,t.Instrument.killAllNotes()}function s(e){return e?t._ctx.currentTime+l:l}var c=e();c.onmessage=n;var a=50,u=0,f=480,h=120;t.ticks2Seconds=function(t){return i(t)/h*60},t.seconds2Ticks=function(t){var e=t/60*h;return o(e)};var g=!1,l=0,_=960,p=4799,v=!1;t.startPlayback=function(){g||(g=!0,l-=t._ctx.currentTime,c.postMessage({playing:!0}))},t.stopPlayback=function(){g&&(r(),g=!1,l=s(!0),c.postMessage({playing:!1}))},t.loopPlayback=function(e){var i=e-p;i>=0&&v===!0&&(console.log("Overshot loopEnd by "+i.toFixed(3)+" ticks @ "+t._ctx.currentTime.toFixed(3)),t.moveToPositionTicks(_+i),n())},t.getPosition=function(){return s(g)},t.moveToPositionTicks=function(e){var n=t.ticks2Seconds(e);t.moveToPositionSeconds(n)},t.moveToPositionSeconds=function(e){g?(r(),l=e-t._ctx.currentTime):l=e},t.getLoopEnabled=function(){return v},t.setLoopEnabled=function(t){v=t},t.getLoopStart=function(){return _},t.setLoopStart=function(t){_=t},t.getLoopEnd=function(){return p},t.setLoopEnd=function(t){p=t}}}(this.Rhombus);